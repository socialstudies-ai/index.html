<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸš€ é£†è‚¡æˆ°æƒ…å®¤ ULTIMATE</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Noto+Sans+TC:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --neon-blue: #00f3ff;
            --neon-green: #00ff9d;
            --neon-red: #ff0055;
            --neon-yellow: #ffee00;
            --bg-dark: #050505;
            --card-bg: rgba(20, 20, 30, 0.75);
            --glass-border: 1px solid rgba(255, 255, 255, 0.1);
        }

        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: var(--bg-dark);
            background-image: 
                radial-gradient(circle at 20% 20%, rgba(0, 243, 255, 0.15) 0%, transparent 40%),
                radial-gradient(circle at 80% 80%, rgba(255, 0, 85, 0.15) 0%, transparent 40%);
            color: #fff;
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1100px;
            margin: 0 auto;
        }

        /* åˆ†é åˆ‡æ›å€ */
        .tabs {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 25px;
        }

        .tab-btn {
            background: rgba(0,0,0,0.5);
            border: 1px solid rgba(255,255,255,0.2);
            color: #888;
            padding: 15px 40px;
            border-radius: 30px;
            font-family: 'Orbitron';
            font-size: 18px;
            cursor: pointer;
            transition: 0.3s;
            position: relative;
            overflow: hidden;
        }
        
        .tab-btn.active {
            color: #fff;
            border-color: var(--neon-blue);
            box-shadow: 0 0 20px rgba(0, 243, 255, 0.2);
            background: rgba(0, 243, 255, 0.1);
        }

        .tab-content { display: none; animation: fadeIn 0.5s; }
        .tab-content.active { display: block; }

        /* å¡ç‰‡å®¹å™¨ */
        .glass-panel {
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: var(--glass-border);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 0 50px rgba(0,0,0,0.6);
        }

        h2 {
            font-family: 'Orbitron', sans-serif;
            text-align: center;
            color: var(--neon-blue);
            text-shadow: 0 0 10px var(--neon-blue);
            margin-top: 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            padding-bottom: 15px;
        }

        /* æƒæå€å¡Šç‰¹åˆ¥æ¨£å¼ */
        .scan-header {
            text-align: center;
            margin-bottom: 20px;
        }
        
        .btn-scan {
            background: linear-gradient(90deg, #ff0055, #ff9f43);
            color: white;
            font-size: 20px;
            padding: 15px 50px;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            font-family: 'Orbitron';
            box-shadow: 0 0 20px rgba(255, 0, 85, 0.4);
            transition: 0.3s;
        }
        .btn-scan:hover { transform: scale(1.05); box-shadow: 0 0 40px rgba(255, 0, 85, 0.8); }
        .btn-scan:disabled { filter: grayscale(1); cursor: not-allowed; }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: #333;
            margin-top: 20px;
            border-radius: 3px;
            overflow: hidden;
            display: none;
        }
        .progress-fill {
            height: 100%;
            background: var(--neon-blue);
            width: 0%;
            transition: width 0.1s;
            box-shadow: 0 0 10px var(--neon-blue);
        }

        /* è¡¨æ ¼èˆ‡è¼¸å…¥æ¡† (æ²¿ç”¨ä¹‹å‰çš„è¨­è¨ˆä½†å„ªåŒ–) */
        .control-panel { display: flex; gap: 10px; margin-bottom: 20px; }
        input { flex: 1; padding: 12px; background: rgba(0,0,0,0.3); border: 1px solid #555; color: #fff; border-radius: 8px; font-family: 'Orbitron'; outline: none; }
        .btn-add { background: #0984e3; color: white; padding: 0 25px; border:none; border-radius: 8px; cursor: pointer; }

        table { width: 100%; border-collapse: separate; border-spacing: 0 8px; }
        th { text-align: left; color: #888; padding: 10px; font-size: 13px; }
        tbody tr { background: rgba(255,255,255,0.03); transition: 0.2s; }
        tbody tr:hover { background: rgba(255,255,255,0.08); transform: translateX(5px); }
        td { padding: 15px; vertical-align: middle; }
        
        .stock-code { color: var(--neon-blue); font-family: 'Orbitron'; font-size: 18px; font-weight: bold; }
        .stock-name { font-size: 14px; color: #ccc; }
        .price { font-family: 'Orbitron'; font-size: 18px; font-weight: bold; }
        
        .tag { display: inline-block; padding: 4px 8px; font-size: 12px; margin: 2px; border-radius: 4px; background: rgba(255,255,255,0.1); color: #aaa; border: 1px solid transparent; }
        .tag.hit { background: rgba(0, 243, 255, 0.1); color: var(--neon-blue); border-color: rgba(0, 243, 255, 0.3); box-shadow: 0 0 5px rgba(0,243,255,0.1); }
        
        .score-display { font-family: 'Orbitron'; font-size: 24px; font-weight: bold; color: var(--neon-green); text-shadow: 0 0 10px var(--neon-green); }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

<div class="container">
    <div class="tabs">
        <div class="tab-btn active" onclick="switchTab('monitor')">æˆ‘çš„ç›£æ§</div>
        <div class="tab-btn" onclick="switchTab('scanner')">å…¨è‡ªå‹•é¸è‚¡æ©Ÿå™¨äºº</div>
    </div>

    <div id="tab-monitor" class="tab-content active glass-panel">
        <h2>PERSONAL MONITOR // å€‹äººç›£æ§</h2>
        <div class="control-panel">
            <input type="text" id="newStockInput" placeholder="è¼¸å…¥ä»£è™Ÿ (EX: 2330)" onkeypress="handleEnter(event)">
            <button class="btn-add" onclick="addStock()">ï¼‹ æ–°å¢</button>
            <button class="btn-add" style="background: #e17055;" onclick="refreshMonitor()">ğŸ”„ åˆ·æ–°</button>
        </div>
        <table id="monitorTable">
            <thead><tr><th width="20%">ä»£è™Ÿ</th><th width="15%">åƒ¹æ ¼</th><th width="50%">ç¬¦åˆç­–ç•¥</th><th width="10%">åˆ†æ•¸</th><th width="5%"></th></tr></thead>
            <tbody id="monitorBody"></tbody>
        </table>
    </div>

    <div id="tab-scanner" class="tab-content glass-panel">
        <h2>MARKET SCANNER // é£†è‚¡ç¯©é¸</h2>
        <div class="scan-header">
            <p style="color:#aaa; font-size:14px; margin-bottom:20px;">
                æƒæç¯„åœï¼šç³»çµ±å…§å»º 150 æª”ç†±é–€æ¬Šå€¼/AI/å‹•èƒ½è‚¡<br>
                ç¯©é¸æ¢ä»¶ï¼šç¬¦åˆ 4 é …ä»¥ä¸ŠæŒ‡æ¨™ (çˆ†é‡ã€å‡ç·šã€KDã€å¸ƒæ—ã€MACDã€RSIã€ç®±å‹çªç ´)
            </p>
            <button class="btn-scan" onclick="runScanner()" id="startScanBtn">ğŸš€ å•Ÿå‹•æƒæç¨‹åº</button>
            <div class="progress-bar" id="scanProgress"><div class="progress-fill" id="scanFill"></div></div>
            <div id="scanStatus" style="margin-top:10px; color:var(--neon-blue); font-family:'Orbitron';">READY</div>
        </div>
        <table id="scanTable">
            <thead><tr><th width="20%">ä»£è™Ÿ</th><th width="15%">åƒ¹æ ¼</th><th width="50%">å¼·å‹¢åŸå›  (ç¬¦åˆæ¢ä»¶)</th><th width="15%">ç¶œåˆè©•åˆ†</th></tr></thead>
            <tbody id="scanBody">
                <tr><td colspan="4" style="text-align:center; padding:30px; color:#555;">å°šæœªåŸ·è¡Œæƒæ</td></tr>
            </tbody>
        </table>
    </div>
</div>

<script>
    // --- è³‡æ–™åº«èˆ‡è¨­å®š ---
    // å…§å»ºç†±é–€è‚¡æ±  (æ¨¡æ“¬è³‡æ–™åº«ï¼ŒåŒ…å«å°è‚¡ä¸»è¦é¡è‚¡)
    const marketPool = [
        "2330","2317","2454","2308","2382","2412","2881","2882","2886","2891","2603","2609","2615","2303","3711","3231","2376","6669","2357","2356","3037","3034","2379","3008","2345","2301","4938","1101","1102","2002","1216","2912","5871","1519","1513","1503","1504","1609","1605","2327","2368","2449","3035","3443","3529","3661","4966","5269","6271","6515","6415","8046","8069","8299","9958","1560","1590","2049","2201","2204","2360","2395","2421","2455","2474","2492","2498","3006","3017","3044","3189","3406","3532","3533","3702","4904","4919","4958","5347","5483","6147","6176","6213","6239","6269","6278","6488","8016","8112","8150","8210","9904","9910","9914","9917","9921","9945","2618","2610","2634","5608","2606","2605","2884","2880","2892","5880","2885","2890","2883","2887","2801","2834"
    ];

    const stockDict = {
        "2330":"å°ç©é›»", "2317":"é´»æµ·", "2454":"è¯ç™¼ç§‘", "2308":"å°é”é›»", "2382":"å»£é”", "2603":"é•·æ¦®", "1519":"è¯åŸ", "3231":"ç·¯å‰µ", "2376":"æŠ€å˜‰", "6669":"ç·¯ç©", "3661":"ä¸–èŠ¯-KY", "1605":"è¯æ–°", "2303":"è¯é›»", "2881":"å¯Œé‚¦é‡‘", "2615":"è¬æµ·", "2609":"é™½æ˜", "2327":"åœ‹å·¨", "3037":"æ¬£èˆˆ", "2357":"è¯ç¢©", "1513":"ä¸­èˆˆé›»"
    };

    let myStocks = JSON.parse(localStorage.getItem('myWatchlist')) || ['2330', '2317'];

    // --- åˆå§‹åŒ– ---
    window.onload = () => { refreshMonitor(); };

    function switchTab(tab) {
        document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
        document.getElementById(`tab-${tab}`).classList.add('active');
        // æ‰¾å‡ºå°æ‡‰æŒ‰éˆ•åŠ  active (é€™è£¡ç°¡å–®è™•ç†)
        event.target.classList.add('active');
    }

    // --- ç›£æ§åŠŸèƒ½ (Tab 1) ---
    function handleEnter(e) { if(e.key === 'Enter') addStock(); }
    function addStock() {
        const val = document.getElementById('newStockInput').value.trim();
        if(val && !myStocks.includes(val)) {
            myStocks.push(val);
            localStorage.setItem('myWatchlist', JSON.stringify(myStocks));
            refreshMonitor();
        }
        document.getElementById('newStockInput').value = '';
    }
    function removeStock(code) {
        if(confirm('ç§»é™¤ç›£æ§?')) {
            myStocks = myStocks.filter(s => s !== code);
            localStorage.setItem('myWatchlist', JSON.stringify(myStocks));
            refreshMonitor();
        }
    }
    async function refreshMonitor() {
        const tbody = document.getElementById('monitorBody');
        tbody.innerHTML = '';
        for(let code of myStocks) {
            const data = await fetchStockData(code);
            if(data) renderRow(tbody, data, true); // true ä»£è¡¨é¡¯ç¤ºç§»é™¤æŒ‰éˆ•
        }
    }

    // --- æƒæåŠŸèƒ½ (Tab 2) ---
    async function runScanner() {
        const btn = document.getElementById('startScanBtn');
        const bar = document.getElementById('scanProgress');
        const fill = document.getElementById('scanFill');
        const status = document.getElementById('scanStatus');
        const tbody = document.getElementById('scanBody');

        btn.disabled = true;
        bar.style.display = 'block';
        tbody.innerHTML = '';
        let foundCount = 0;

        for(let i=0; i<marketPool.length; i++) {
            const code = marketPool[i];
            const pct = Math.round(((i+1)/marketPool.length)*100);
            fill.style.width = pct + "%";
            status.innerText = `SCANNING [${code}] ... ${pct}%`;

            const data = await fetchStockData(code);
            if(data && data.score >= 4) { // åªé¡¯ç¤ºç¬¦åˆ 4 é …ä»¥ä¸Šçš„
                renderRow(tbody, data, false);
                foundCount++;
            }
            // é¿å…éå¿«è«‹æ±‚
            await new Promise(r => setTimeout(r, 100));
        }

        status.innerText = `SCAN COMPLETE. FOUND ${foundCount} TARGETS.`;
        if(foundCount === 0) tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; padding:20px;">æœ¬æ¬¡æƒæç„¡ç¬¦åˆ 4 é …ä»¥ä¸Šæ¢ä»¶ä¹‹æ¨™çš„</td></tr>';
        btn.disabled = false;
    }

    // --- æ ¸å¿ƒé‚è¼¯ï¼šæŠ“å–èˆ‡è¨ˆç®— ---
    async function fetchStockData(code) {
        try {
            const proxy = `https://api.allorigins.win/get?url=${encodeURIComponent(`https://query1.finance.yahoo.com/v8/finance/chart/${code}.TW?interval=1d&range=6mo`)}`;
            const res = await fetch(proxy);
            const raw = await res.json();
            const json = JSON.parse(raw.contents);
            if(!json.chart || !json.chart.result) return null;
            
            const result = json.chart.result[0];
            const meta = result.meta;
            const q = result.indicators.quote[0];
            const ts = result.timestamp;

            let candles = [];
            for(let i=0; i<q.close.length; i++) {
                if(q.close[i] != null) candles.push({ close: q.close[i], high: q.high[i], low: q.low[i], vol: q.volume[i], ts: ts[i] });
            }
            if(candles.length < 50) return null;

            return analyzeStrategy(code, meta.symbol, candles);
        } catch(e) { return null; }
    }

    function analyzeStrategy(code, symbol, candles) {
        const last = candles[candles.length-1];
        const prev = candles[candles.length-2];
        let score = 0;
        let tags = [];

        // 1. ç«™ä¸Š 5MA ä¸” 5MA å‘ä¸Š
        const ma5 = calcMA(candles, 5);
        const currMA5 = ma5[ma5.length-1];
        const prevMA5 = ma5[ma5.length-2];
        if(last.close > currMA5 && currMA5 > prevMA5) { score++; tags.push("5MAç¿»æš"); }

        // 2. å¸ƒæ—ä¸Šè»Œçªç ´ (å–‡å­é–‹å£)
        const bb = calcBB(candles, 20, 2);
        const upper = bb.u[bb.u.length-1];
        const prevUpper = bb.u[bb.u.length-2];
        // åˆ¤æ–·é–‹å£æ”¾å¤§ï¼šä¸Šè»Œè®Šé«˜å¹…åº¦æ˜é¡¯
        if(last.close >= upper * 0.99 && (upper > prevUpper * 1.005)) { score++; tags.push("å¸ƒæ—çªç ´"); }

        // 3. ç®±å‹çªç ´ / å‰µ 20 æ—¥æ–°é«˜
        const past20High = Math.max(...candles.slice(-22, -2).map(c=>c.high));
        if(last.close > past20High) { score++; tags.push("å‰µæ³¢æ®µé«˜"); }

        // 4. KD é»ƒé‡‘äº¤å‰ æˆ– é«˜æª”éˆåŒ–
        const kd = calcKD(candles);
        const k = kd.k[kd.k.length-1], d = kd.d[kd.d.length-1];
        const pK = kd.k[kd.k.length-2], pD = kd.d[kd.d.length-2];
        if((k>d && pK<pD) || (k>80 && k>d)) { score++; tags.push("KDå¼·å‹¢"); }

        // 5. MACD ç´…æŸ±æ”¾å¤§æˆ–ç¿»ç´…
        const macd = calcMACD(candles);
        const hist = macd[macd.length-1];
        const pHist = macd[macd.length-2];
        if(hist > 0 && (hist > pHist || pHist < 0)) { score++; tags.push("MACDæ”»æ“Š"); }

        // 6. RSI å¼·å‹¢ (>50 ä¸”å‘ä¸Š)
        const rsi = calcRSI(candles);
        const currRSI = rsi[rsi.length-1];
        if(currRSI > 50 && currRSI > rsi[rsi.length-2]) { score++; tags.push("RSIè½‰å¼·"); }

        // 7. çˆ†é‡é•·ç´… (é‡ > 5æ—¥å‡é‡ * 1.5 ä¸” æ¼²å¹… > 3%)
        const volMA = calcVolMA(candles, 5);
        const avgVol = volMA[volMA.length-1];
        const changePct = (last.close - prev.close) / prev.close;
        if(last.vol > avgVol * 1.5 && changePct > 0.03) { score++; tags.push("çˆ†é‡é•·ç´…"); }

        // 8. å¤–è³‡/ä¸»åŠ› (æ¨¡æ“¬åˆ¤æ–·ï¼šè‹¥åˆ†æ•¸å·²é«˜ä¸”çˆ†é‡ï¼Œæ¨™è¨»éœ€ç¢ºèª)
        // å› ç„¡æ³•æŠ“å³æ™‚ç±Œç¢¼ï¼Œé€™è£¡åšä¸€å€‹è¼”åŠ©åˆ¤æ–·ï¼šåƒ¹æ¼²é‡å¢ä¸”å‹æ…‹å¥½
        if(score >= 4 && last.vol > avgVol) { 
            // é€™è£¡ä¸åŠ åˆ†ï¼Œä½†é¡¯ç¤ºæ¨™ç±¤æé†’æª¢æŸ¥
            tags.push("ç±Œç¢¼ç–‘ä¼¼é€²é§"); 
        }

        return {
            code: code,
            name: stockDict[code] || symbol,
            price: last.close.toFixed(2),
            score: score,
            tags: tags
        };
    }

    function renderRow(tbody, data, isMonitor) {
        const tr = document.createElement('tr');
        const tagHtml = data.tags.map(t => `<span class="tag hit">${t}</span>`).join('');
        
        let scoreColor = data.score >= 5 ? 'var(--neon-green)' : (data.score>=3 ? 'var(--neon-yellow)' : '#555');

        tr.innerHTML = `
            <td>
                <div class="stock-code">${data.code}</div>
                <div class="stock-name">${data.name}</div>
            </td>
            <td class="price">${data.price}</td>
            <td>${tagHtml}</td>
            <td><div class="score-display" style="color:${scoreColor}">${data.score}</div></td>
            ${isMonitor ? `<td><button onclick="removeStock('${data.code}')" style="background:none;border:none;color:#555;cursor:pointer;">Ã—</button></td>` : ''}
        `;
        tbody.appendChild(tr);
    }

    // --- æ•¸å­¸é‹ç®— ---
    function calcMA(d,n){let r=[];for(let i=0;i<d.length;i++){if(i<n-1){r.push(0);continue;}let s=0;for(let j=0;j<n;j++)s+=d[i-j].close;r.push(s/n);}return r;}
    function calcVolMA(d,n){let r=[];for(let i=0;i<d.length;i++){if(i<n-1){r.push(0);continue;}let s=0;for(let j=0;j<n;j++)s+=d[i-j].vol;r.push(s/n);}return r;}
    function calcBB(d,n,k){const ma=calcMA(d,n);let u=[];for(let i=0;i<d.length;i++){if(i<n-1){u.push(0);continue;}let s=0;for(let j=0;j<n;j++)s+=Math.pow(d[i-j].close-ma[i],2);u.push(ma[i]+k*Math.sqrt(s/n));}return {u};}
    function calcKD(d){let k=[50],v=[50];for(let i=1;i<d.length;i++){let h=-Infinity,l=Infinity;for(let j=0;j<9&&i-j>=0;j++){if(d[i-j].high>h)h=d[i-j].high;if(d[i-j].low<l)l=d[i-j].low;}let rsv=(h==l)?50:((d[i].close-l)/(h-l)*100);let ck=(2/3)*k[i-1]+(1/3)*rsv;let cd=(2/3)*v[i-1]+(1/3)*ck;k.push(ck);v.push(cd);}return {k,d:v};}
    function calcMACD(d){let e12=cE(d,12),e26=cE(d,26),df=[],dm=[],h=[];for(let i=0;i<d.length;i++)df.push(e12[i]-e26[i]);dm.push(df[0]);let k=2/10;for(let i=1;i<df.length;i++)dm.push(df[i]*k+dm[i-1]*(1-k));for(let i=0;i<df.length;i++)h.push(df[i]-dm[i]);return h;}
    function cE(d,n){let k=2/(n+1),r=[d[0].close];for(let i=1;i<d.length;i++)r.push(d[i].close*k+r[i-1]*(1-k));return r;}
    function calcRSI(d){let r=[0];for(let i=14;i<d.length;i++){let g=0,l=0;for(let j=0;j<14;j++){let df=d[i-j].close-d[i-j-1].close;if(df>0)g+=df;else l-=df;}let rs=g/l;r.push(l==0?100:100-(100/(1+rs)));}while(r.length<d.length)r.unshift(0);return r;}
</script>

</body>
</html>